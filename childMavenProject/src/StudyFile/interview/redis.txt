【面试】redis缓存穿透、缓存击穿、缓存雪崩区别和解决方案

缓存穿透
描述:
    1.缓存穿透是指缓存和数据库中都没有的数据，而用户不断发起请求。由于缓存是不命中时被动写的，并且出于容错考虑，
    如果从存储层查不到数据则不写入缓存，这将导致这个不存在的数据每次请求都要到存储层去查询，失去了缓存的意义。
    2.在流量大时，可能DB就挂掉了，要是有人利用不存在的key频繁攻击我们的应用，这就是漏洞。
    3.如发起为id为“-1”的数据或id为特别大不存在的数据。这时的用户很可能是攻击者，攻击会导致数据库压力过大。

解决方案:
    1.接口层增加校验，如用户鉴权校验，id做基础校验，id<=0的直接拦截；
    2.从缓存取不到的数据，在数据库中也没有取到，这时也可以将key-value对写为key-null，缓存有效时间可以设置短点，
    3.如30秒（设置太长会导致正常情况也没法使用）。这样可以防止攻击用户反复用同一个id暴力攻击

缓存击穿
描述：
    1.缓存击穿是指缓存中没有但数据库中有的数据（一般是缓存时间到期），这时由于并发用户特别多，同时读缓存没读到数据，
    2.又同时去数据库去取数据，引起数据库压力瞬间增大，造成过大压力。

解决方案：
    1、设置热点数据永远不过期。
    2、接口限流与熔断，降级。重要的接口一定要做好限流策略，防止用户恶意刷接口，同时要降级准备，当接口中的某些服务
    不可用时候，进行熔断，失败快速返回机制。
    3、布隆过滤器。bloomfilter就类似于一个hash set，用于快速判某个元素是否存在于集合中，其典型的应用场景就是
    快速判断一个key是否存在于某容器，不存在就直接返回。布隆过滤器的关键就在于hash算法和容器大小，
    4、加互斥锁，互斥锁参考代码如下：


缓存雪崩
描述：
    1.缓存雪崩是指缓存中数据大批量到过期时间，而查询数据量巨大，引起数据库压力过大甚至down机。和缓存击穿不同的是，
    2.缓存击穿指并发查同一条数据，缓存雪崩是不同数据都过期了，很多数据都查不到从而查数据库。

解决方案：
    1.缓存数据的过期时间设置随机，防止同一时间大量数据过期现象发生。
    2.如果缓存数据库是分布式部署，将热点数据均匀分布在不同的缓存数据库中。
    3.设置热点数据永远不过期。

Redis的内存淘汰策略有哪些

对所有key的三种淘汰机制
noeviction 不淘汰
allkeys-lru:
allkeys-random:

对有过期时间的三种淘汰机制
volatile-lru
volatile-random
volatile-ttl 最早过期淘汰

presist key 永不过期
expire key 设置过期时间

redis集群原理
不同节点之间相互通信，最终达到数据一致的情况

redis寻址方式：
普通hash方法
来了一个key之后对节点数取模，一旦一个节点宕机，会根据存活节点取模，这样会导致大量
数据在取模后的节点无法找到对应的缓存数据，大量访问数据库，形成缓存击穿

hash一致
将所有hash值建立一个虚拟圆环，每当新key来的时候，先对其（ip或者机器名）进行hash，
然后根据hash之后的位置找到第一个节点即可，增加也是如此
不过节点较少会造成热点数据问题，因此引入虚拟节点机制，可以对一个节点多次hash，每个位置
放一个虚拟节点，实现了数据的均匀分配，负载均衡。

redis cluster 中的 hash slot
hash slot默认有2^14=16384个hash槽，对每个节点进行平均分配，当节点宕机的时候
重新分配其hash槽到其他节点即可，分配hash槽的成本很低，所以宕机转移特别容易

集群维护元数据的方式有两种
集中式（由几个主Master向附近节点扩散数据）
gossip协议（每个节点互为master节点，将更新均分在不同节点上，降低压力，但是有时延）

